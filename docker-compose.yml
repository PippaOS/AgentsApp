services:
  runner:
    runtime: runsc  # <--- This tells the container runtime to use the tank we just purchased.
    build:
      context: .
      dockerfile: runner/Dockerfile
    environment:
      - RUNNER_SHARED_DIR=/shared
      - NATS_URL=nats://nats:4222
    # Standard fortress protocol. If they get in, they're stuck in the mud.
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    volumes:
      - /tmp/pippachat-shared:/shared:ro
      # Eyes only. They can read the playbook, but they ain't changing a single number.
      # No writes back to the house. Everything stays clean.
      - ./src:/workspace/src:ro
    depends_on:
      - nats

  nats:
    image: nats:latest
    ports:
      - "127.0.0.1:4222:4222"  # Main line for the associates
      - "127.0.0.1:8222:8222"  # Surveillance feed
      - "127.0.0.1:6222:6222"  # Backroom chatter
    command: ["-m", "8222"]